---
title: å­¦æ ¡æœåŠ¡å™¨ï¼ˆå†…ç½‘ï¼‰
icon: ph:computer-tower-duotone
---

# å­¦æ ¡æœåŠ¡å™¨éƒ¨ç½²

## ä»‹ç»

![æœåŠ¡å™¨ç»“æ„ç¤ºæ„å›¾](/local-server-structure.png)

æ•´ä¸ªåº”ç”¨ç¨‹åºä¾èµ–ä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ç”± Node.js è¿è¡Œçš„ Nuxt éƒ¨åˆ†ï¼Œæ•°æ®åº“éƒ¨åˆ†ï¼Œå’Œæ–‡ä»¶å­˜å‚¨éƒ¨åˆ†ã€‚Nuxt éƒ¨åˆ†ç”± pm2 å·¥å…·å¯åŠ¨ï¼Œå¹¶ä¸”åœ¨åå°è¿è¡Œï¼›æ•°æ®åº“å’Œæ–‡ä»¶å­˜å‚¨éƒ¨åˆ†å‡ä½¿ç”¨ systemd è¿è¡Œã€‚

## ç›¸å…³æ–‡æ¡£

::card-group{class="mt-6"}
  ::card
  ---
  title: PM2
  to: https://pm2.keymetrics.io/docs/usage/quick-start/
  target: _blank
  ---
  ::
  ::card
  ---
  title: postgresql
  to: https://www.postgresql.org/
  target: _blank
  ---
  ::
  ::card
  ---
  title: MinIO
  to: https://min.io/docs/minio/kubernetes/upstream/
  target: _blank
  ---
  ::
  ::card
  ---
  title: Nuxtï¼ˆéƒ¨ç½²ç›¸å…³ï¼‰
  to: https://nuxt.com/docs/getting-started/deployment
  target: _blank
  ---
  ::
::

## å®‰è£…å’Œé…ç½®æ•°æ®åº“

::steps{level=4}
#### å®‰è£… PostgreSQL

```bash
sudo apt install postgresql
```

#### è¿›å…¥ PostgreSQL å‘½ä»¤è¡Œ

```bash
sudo -u postgres psql
```

å‘½ä»¤è¡Œé•¿è¿™æ · ğŸ‘‡

```
psql (16.4 (Ubuntu 16.4-0ubuntu0.24.04.2))
Type "help" for help.

postgres=#
```

#### åˆ›å»ºæ•°æ®åº“ç”¨æˆ·

å°†å‘½ä»¤ä¸­çš„ `username` å’Œ `password` ï¼ˆå°å†™ï¼‰æ”¹æˆå…·ä½“çš„ç”¨æˆ·åå’Œå¯†ç ã€‚è¯·å¦¥å–„ä¿ç®¡æ•°æ®åº“å¯†ç ã€‚

```sql
CREATE ROLE username WITH LOGIN PASSWORD 'password';
```

#### åˆ›å»ºæ•°æ®åº“

å°†å‘½ä»¤ä¸­çš„ `database_name` å’Œ `username` åˆ†åˆ«æ”¹æˆå…·ä½“çš„æ•°æ®åº“åç§°å’Œç¬¬ä¸‰æ­¥ä¸­è®¾ç½®çš„ç”¨æˆ·åã€‚

```sql
CREATE DATABASE database_name OWNER username;
```

#### é€€å‡ºå‘½ä»¤è¡Œ

åœ¨ PostgreSQL å‘½ä»¤è¡Œä¸­è¾“å…¥ `\q` å¯é€€å‡ºå‘½ä»¤è¡Œã€‚

#### è·å– URL

æ•°æ®åº“å¯¹åº”çš„ URL ä¸ºï¼š

```
postgresql://username:password@localhost/database_name
```

å…¶ä¸­ `username`ï¼Œ`password`ï¼Œ`database_name` å‡æ›¿æ¢ä¸ºä¸Šè¿°æ­¥éª¤ä¸­è®¾ç½®çš„å†…å®¹ã€‚æ­¤ URL å°†åœ¨ä¸‹æ–‡ä¸­è¢«å¡«å…¥ç¯å¢ƒå˜é‡ä¸­ã€‚
::

## å®‰è£…å’Œé…ç½® MINIO

MINIO æ˜¯ä¸€ä¸ªå¼€æºçš„å…¼å®¹ S3 åè®®çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ã€‚æˆ‘ä»¬ä½¿ç”¨ systemd æ¥ç®¡ç† MINIO æœåŠ¡ã€‚

::steps{level=4}
#### å®‰è£… MINIO

```bash
curl -O https://dl.min.io/server/minio/release/linux-amd64/minio
chmod +x minio
sudo mv minio /usr/local/bin/
```

ä»¥ä¸Šå‘½ä»¤ç¬¬ä¸€è¡Œä¸‹è½½äº† MINIO çš„å®‰è£…åŒ…ï¼Œç¬¬äºŒè¡Œå°†å…¶è®¾ç½®ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç¬¬ä¸‰è¡Œå°†å…¶ç§»åŠ¨åˆ° `/usr/local/bin/` ç›®å½•ä¸‹ã€‚
å¦‚æœå›½å†…è®¿é—®é€Ÿåº¦æ…¢ï¼Œå¯ä»¥è€ƒè™‘å…ˆä¸‹è½½åˆ°æœ¬åœ°åä¸Šä¼ ã€‚

#### é…ç½® MINIO ç¯å¢ƒå˜é‡

```bash
sudo nano /etc/default/minio
```

è¿™é‡Œä½¿ç”¨äº† Ubuntu è‡ªå¸¦çš„ nano ç¼–è¾‘å™¨ã€‚æŠŠä»¥ä¸‹å†…å®¹å¤åˆ¶åˆ° nano ä¸­ï¼š

```ini [/etc/default/minio]
# Volume to be used for MinIO server.
MINIO_VOLUMES="/mnt/data"
# Use if you want to run MinIO on a custom port.
MINIO_OPTS="--address :9199 --console-address :9001"
# Root user for the server.
MINIO_ROOT_USER=MINIO-USERNAME
# Root secret for the server.
MINIO_ROOT_PASSWORD=MINIO-PASSWORD
```
ä¸Šè¿°æ–‡ä»¶ä¸­çš„ `MINIO-USERNAME` å’Œ `MINIO-PASSWORD` éœ€è¦æ›¿æ¢ä¸ºä½ æƒ³è¦è®¾å®šçš„ MINIO ç®¡ç†å‘˜ç”¨æˆ·åå’Œå¯†ç ã€‚è¯¥ç”¨æˆ·åå’Œå¯†ç ç¨åå°†ç”¨äºç™»å½• MinIO çš„ Web ç•Œé¢ã€‚**æ³¨æ„ï¼Œä¸æ˜¯ Linux ç”¨æˆ·åå’Œå¯†ç ã€‚**

ç¼–è¾‘å¥½ä¹‹åä½¿ç”¨ `Ctrl+S` ä¿å­˜ï¼Œç„¶åä½¿ç”¨ `Ctrl+X` é€€å‡º nano ç¼–è¾‘å™¨ã€‚

#### ç¼–å†™ service æ–‡ä»¶

```bash
sudo nano /etc/systemd/system/minio.service
```

åœ¨æ–‡ä»¶ä¸­å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```ini [/etc/systemd/system/minio.service]
[Unit]
Description=MinIO
Documentation=https://docs.min.io
Wants=network-online.target
After=network-online.target
AssertFileIsExecutable=/usr/local/bin/minio
AssertFileNotEmpty=/etc/default/minio

[Service]
Type=notify

WorkingDirectory=/usr/local/

User=USERNAME
Group=USERNAME
ProtectProc=invisible

EnvironmentFile=/etc/default/minio
ExecStart=/usr/local/bin/minio server $MINIO_OPTS $MINIO_VOLUMES

# Let systemd restart this service always
Restart=always

# Specifies the maximum file descriptor number that can be opened by this process
LimitNOFILE=1048576

# Specifies the maximum number of threads this process can create
TasksMax=infinity

# Disable timeout logic and wait until process is stopped
TimeoutSec=infinity

SendSIGKILL=no

[Install]
WantedBy=multi-user.target
```
ä¸Šè¿°æ–‡ä»¶ä¸­çš„ `USERNAME` éœ€è¦æ›¿æ¢ä¸ºä½ çš„ç”¨æˆ·åã€‚å­˜å‚¨æ•°æ®çš„æ–‡ä»¶å¤¹è¢«è®¾ç½®ä¸º `/mnt/data`ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è‡ªè¡Œä¿®æ”¹ã€‚

#### å¯åŠ¨ MINIO

æ¯æ¬¡æ›´æ”¹ service æ–‡ä»¶åï¼Œéœ€è¦é‡æ–°åŠ è½½ systemd æœåŠ¡ï¼š
```bash
sudo systemctl daemon-reload
```

åˆæ¬¡ä½¿ç”¨æ—¶éœ€è¦å¯ç”¨è¯¥æœåŠ¡ï¼ˆåœ¨åç»­ç»´æŠ¤ä¸­åˆ™ä¸éœ€è¦è¿è¡Œè¯¥å‘½ä»¤ï¼‰ï¼š
```bash
sudo systemctl enable minio
```

å¯åŠ¨ MINIOï¼š
```bash
sudo systemctl start minio
```
::alert{icon="lucide:info"}
è¿è¡Œå¯åŠ¨å‘½ä»¤ä¹‹åä¼šè¿”å›æ˜¯å¦å¯åŠ¨æˆåŠŸçš„ä¿¡æ¯ï¼Œè¯·ä»”ç»†æŸ¥çœ‹ã€‚
::

#### æ“ä½œ MINIO æœåŠ¡

æŸ¥çœ‹ MINIO çŠ¶æ€ï¼š
```bash
sudo systemctl status minio
```

åœæ­¢ MINIOï¼š
```bash
sudo systemctl stop minio
```

é‡å¯ MINIOï¼š
```bash
sudo systemctl restart minio
```

æŸ¥çœ‹ MINIO æ—¥å¿—ï¼š
```bash
sudo journalctl -u minio
```

#### è®¿é—® MINIO çš„ Web ç•Œé¢è¿›è¡Œç®¡ç†

ä½¿ç”¨æµè§ˆå™¨è®¿é—® `http://æœåŠ¡å™¨ip:9001`ï¼Œç”¨ä¹‹å‰è®¾ç½®çš„ç®¡ç†å‘˜ç”¨æˆ·åå’Œå¯†ç ç™»å½•ã€‚

##### åˆ›å»ºè®¿é—®å¯†é’¥

åœ¨å·¦è¾¹æ è¿›å…¥ Access Keys é¡µé¢ï¼Œç‚¹å‡»å³ä¸Šè§’ Create New Access Key æŒ‰é’®ï¼Œç‚¹å‡» Create ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„è®¿é—®å¯†é’¥ã€‚
å°† Access Key å’Œ Secret Key å†…å®¹è®°å½•ä¸‹æ¥ï¼Œä»¥å¡«å…¥åæ–‡ä¸­çš„ pm2 é…ç½®æ–‡ä»¶ä¸­ã€‚

##### åˆ›å»ºå­˜å‚¨æ¡¶

åœ¨å·¦è¾¹æ è¿›å…¥ Buckets é¡µé¢ï¼Œç‚¹å‡»å³ä¸Šè§’ Create Bucket æŒ‰é’®ï¼Œè¾“å…¥å­˜å‚¨æ¡¶åç§°ï¼Œç‚¹å‡» Create Bucket ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„å­˜å‚¨æ¡¶ã€‚
è®°å½•å­˜å‚¨æ¡¶åç§°ï¼Œä»¥å¡«å…¥åæ–‡ä¸­çš„ pm2 é…ç½®æ–‡ä»¶ä¸­ã€‚
::

## è¿è¡Œ Nuxt éƒ¨åˆ†

::alert{type="success" icon="lucide:lightbulb"}
è¯·ç¡®ä¿å·²ç»å®‰è£…äº† Node.js å’Œ pnpmã€‚
::

::steps{level=4}
#### è¿è¡Œä»¥ä¸‹å‘½ä»¤æ‹‰å–å¹¶æ„å»º

```bash
git clone https://github.com/SMS-COSMO/SMS-Tree.git
cd SMS-Tree
pnpm install --registry=https://registry.npmmirror.com
pnpm build
```

#### è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… pm2

```bash
pnpm install pm2 -g
```

#### é…ç½® pm2

åœ¨ `SMS-Tree/` çš„**çˆ¶çº§**ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶ `ecosystem.config.js`ï¼Œå…¶ä¸­ `env: {}` çš„å†…å®¹ä¸ `.env` ç›¸åŒï¼š

::alert{to="/introduction/getting-started/env"}
ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ `.env` çš„é…ç½®æ–¹æ³•
::

```js [å†…å®¹ç¤ºä¾‹]
module.exports = {
  apps: [
    {
      name: 'SMS-Tree',
      script: './SMS-Tree/.output/server/index.mjs',
      instances: 'max',
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3000,
        DATABASE_URL: 'postgresql://username:password@localhost/database_name',
        SIGN_PUBLIC_KEY: '',
        SIGN_PRIVATE_KEY: '',
        ENC_PUBLIC_KEY: '',
        ENC_PRIVATE_KEY: '',
        ENC_KID: '',
        SIGN_KID: '',
        SERVER_URL: '',
        S3_ACCESS_KEY_ID: '',
        S3_SECRET_ACCESS_KEY: '',
        BUCKET_NAME: '',
        S3_SERVER_URL: '',
      },
    },
  ],
};
```

#### å¯åŠ¨ pm2

```bash
pm2 start ecosystem.config.js
```

#### å¯è¿›è¡Œçš„ pm2 æ“ä½œæœ‰

æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹åˆ—è¡¨ï¼š

```bash
pm2 list
```

æ‰“å¼€è¿›ç¨‹ç®¡ç†å™¨ï¼š

```bash
pm2 monit
```

æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
pm2 logs
```

åœæ­¢æ‰€æœ‰è¿›ç¨‹ï¼š

```bash
pm2 delete all
```

åœæ­¢ç‰¹å®šçš„è¿›ç¨‹ï¼ˆ`<id>` ä¸ºæŸ¥çœ‹åˆ—è¡¨æ—¶è¾“å‡ºçš„å¯¹åº”è¿›ç¨‹çš„ idï¼‰ï¼š

```bash
pm2 delete <id>
```

::alert{type="info" icon="lucide:info"}
  å½“ç¯å¢ƒå˜é‡æ›´æ”¹æˆ–é‡æ–°æ„å»ºåï¼Œéœ€è¦å…ˆåˆ é™¤æ‰€æœ‰ç›¸åº”çš„ pm2 è¿›ç¨‹ï¼Œå†é‡æ–°å¯åŠ¨ pm2ã€‚
::
::
